<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wired Client History - Mist Site Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --tm-magenta: #E20074;
            --tm-magenta-dark: #B8005D;
            --tm-magenta-light: #FF3399;
            --bg-primary: #1A1A1A;
            --bg-secondary: #2D2D2D;
            --bg-card: #3D3D3D;
            --bg-card-header: #4A4A4A;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --accent-green: #00C853;
            --accent-red: #FF5252;
            --accent-yellow: #FFD600;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--tm-magenta) 0%, var(--tm-magenta-dark) 100%) !important;
            border-bottom: none;
            box-shadow: 0 2px 10px rgba(226, 0, 116, 0.3);
        }
        
        .navbar-brand {
            color: var(--text-primary) !important;
            font-weight: 700;
        }
        
        .card {
            background-color: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            background-color: var(--bg-card-header);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
        }
        
        .table-dark {
            --bs-table-bg: var(--bg-card);
            --bs-table-border-color: rgba(255,255,255,0.1);
        }
        
        .table-dark thead th {
            background-color: var(--bg-card-header);
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 2px solid var(--tm-magenta);
        }
        
        .sortable {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: rgba(226, 0, 116, 0.2);
        }
        
        .sortable.sort-asc i::before {
            content: "\F128"; /* bi-arrow-up */
        }
        
        .sortable.sort-desc i::before {
            content: "\F126"; /* bi-arrow-down */
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--tm-magenta) 0%, var(--tm-magenta-dark) 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--tm-magenta-light) 0%, var(--tm-magenta) 100%);
        }
        
        .badge.bg-success { background: linear-gradient(135deg, var(--accent-green) 0%, #00A846 100%) !important; }
        .badge.bg-warning { background: linear-gradient(135deg, var(--accent-yellow) 0%, #E6C200 100%) !important; color: #1A1A1A !important; }
        .badge.bg-danger { background: linear-gradient(135deg, var(--accent-red) 0%, #E64545 100%) !important; }
        .badge.bg-info { background: linear-gradient(135deg, var(--tm-magenta) 0%, var(--tm-magenta-dark) 100%) !important; }
        
        .loading-spinner {
            display: none;
        }
        
        .loading .loading-spinner {
            display: inline-block;
        }
        
        .stats-card {
            text-align: center;
            padding: 1rem;
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--tm-magenta-light);
        }
        
        .stats-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .auth-badge.authenticated {
            background-color: rgba(0, 200, 83, 0.2);
            color: var(--accent-green);
        }
        
        .auth-badge.not-authenticated {
            background-color: rgba(255, 82, 82, 0.2);
            color: var(--accent-red);
        }
        
        /* CSV Download Button */
        .btn-csv-download {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .btn-csv-download:hover {
            background: rgba(226, 0, 116, 0.2);
            border-color: var(--tm-magenta);
            color: var(--text-primary);
        }
        
        .btn-csv-download i {
            margin-right: 0.25rem;
        }
        
        /* Icon color utilities */
        .icon-magenta {
            color: var(--tm-magenta);
        }
        
        .icon-magenta-light {
            color: var(--tm-magenta-light);
        }
        
        /* Empty state icon */
        .empty-icon-light {
            font-size: 4rem;
            color: var(--tm-magenta-light);
            opacity: 0.5;
        }
        
        /* Initially hidden elements (toggled by JS) */
        .initially-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/?site={{ site_id }}">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </a>
            <span class="navbar-text text-white">
                <i class="bi bi-hdd-stack me-2"></i>Wired Client History (Last 7 Days)
            </span>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Stats Summary -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card stats-card">
                    <div class="stats-value" id="totalClients">-</div>
                    <div class="stats-label">Total Clients</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card stats-card">
                    <div class="stats-value" id="connectedCount">-</div>
                    <div class="stats-label">Currently Connected</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card stats-card">
                    <div class="stats-value" id="switchCount">-</div>
                    <div class="stats-label">Switches Used</div>
                </div>
            </div>
        </div>

        <!-- Wired Clients Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-ethernet me-2"></i>Wired Client History</span>
                <div>
                    <button class="btn btn-csv-download me-2" onclick="downloadTableAsCSV('clientTable', 'wired_clients.csv')">
                        <i class="bi bi-download"></i>CSV
                    </button>
                    <button id="refreshBtn" class="btn btn-sm btn-primary">
                        <span class="loading-spinner spinner-border spinner-border-sm me-1"></span>
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="loadingMessage" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="text-secondary">Loading wired client data...</p>
                </div>
                <div id="dataTable" class="initially-hidden">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="clientTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="is_connected">Status <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sortable" data-sort="hostname">Hostname <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sortable" data-sort="mac">MAC Address <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sortable" data-sort="ip">IPv4 Address <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sortable" data-sort="username">Username <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sortable" data-sort="connected_time">Connected Time <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sortable" data-sort="last_seen">Last Seen <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sortable" data-sort="device_type">Device OS/Type <i class="bi bi-arrow-down-up"></i></th>
                                </tr>
                            </thead>
                            <tbody id="clientsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="emptyMessage" class="text-center py-5 initially-hidden">
                    <i class="bi bi-inbox empty-icon-light"></i>
                    <p class="text-secondary mt-3">No wired clients found in the last 7 days</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const siteId = '{{ site_id }}';
        let clientsData = [];
        let currentSort = { column: 'is_connected', direction: 'desc' };
        
        // Download table as CSV
        function downloadTableAsCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.querySelectorAll('tr');
            const csvContent = [];
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                cols.forEach(col => {
                    let text = col.innerText.replace(/[\n\r]+/g, ' ').trim();
                    if (text.includes(',') || text.includes('"')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    rowData.push(text);
                });
                csvContent.push(rowData.join(','));
            });
            
            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp || timestamp === 0 || timestamp < 0) return '-';
            // Validate the timestamp produces a reasonable date (after year 2000)
            if (timestamp < 946684800) return '-';  // Before Jan 1, 2000
            const date = new Date(timestamp * 1000);
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleString();
        }
        
        function sortData(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            clientsData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                // Handle array values (take first element)
                if (Array.isArray(aVal)) aVal = aVal[0] || '';
                if (Array.isArray(bVal)) bVal = bVal[0] || '';
                
                // Handle numeric comparisons
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                // Handle string comparisons
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
                
                if (currentSort.direction === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            renderTable();
            updateSortIndicators();
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort.column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        function renderTable() {
            const tbody = document.getElementById('clientsTable');
            tbody.innerHTML = clientsData.map(client => {
                const statusBadge = client.is_connected 
                    ? '<span class="badge bg-success"><i class="bi bi-ethernet me-1"></i>Connected</span>'
                    : '<span class="badge bg-secondary">Disconnected</span>';
                return `
                    <tr>
                        <td>${statusBadge}</td>
                        <td>${client.hostname || '-'}</td>
                        <td><code>${client.mac || '-'}</code></td>
                        <td>${client.ip || '-'}</td>
                        <td>${client.username || '-'}</td>
                        <td><small>${formatTimestamp(client.connected_time)}</small></td>
                        <td><small>${formatTimestamp(client.last_seen)}</small></td>
                        <td><small>${client.device_type || '-'}</small></td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadData() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('emptyMessage').style.display = 'none';
            document.getElementById('refreshBtn').classList.add('loading');
            
            try {
                const response = await fetch(`/api/sites/${siteId}/wired-clients`);
                const data = await response.json();
                
                if (data.success && data.clients && data.clients.length > 0) {
                    // Data is already in the correct format from backend
                    clientsData = data.clients;
                    
                    // Calculate stats
                    const connectedCount = clientsData.filter(c => c.is_connected).length;
                    const uniqueSwitches = new Set(clientsData.map(c => c.switch_mac).filter(v => v)).size;
                    
                    document.getElementById('totalClients').textContent = clientsData.length;
                    document.getElementById('connectedCount').textContent = connectedCount;
                    document.getElementById('switchCount').textContent = uniqueSwitches;
                    
                    // Sort by connected status first (connected at top) and render
                    sortData('is_connected');
                    
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('dataTable').style.display = 'block';
                } else {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('emptyMessage').style.display = 'block';
                    
                    document.getElementById('totalClients').textContent = '0';
                    document.getElementById('connectedCount').textContent = '0';
                    document.getElementById('switchCount').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <p class="text-danger mt-3">Error loading data: ${error.message}</p>
                `;
            } finally {
                document.getElementById('refreshBtn').classList.remove('loading');
            }
        }
        
        // Set up sort click handlers
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => sortData(th.dataset.sort));
        });
        
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
